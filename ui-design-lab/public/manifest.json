{
  "generatedAt": "2026-02-15T08:07:16.374Z",
  "workspaceRoot": "/Volumes/Madrays/sundev",
  "gridStandard": {
    "unit": 76,
    "gap": 22
  },
  "apps": [
    {
      "id": "holiday-countdown-app",
      "path": "holiday-countdown-app",
      "componentsConfig": "holiday-countdown-app/config/components.config.js",
      "widgets": [
        {
          "id": "holiday-countdown-widget",
          "sizes": [
            "1x1",
            "1x2",
            "2x1",
            "2x2",
            "2x4"
          ],
          "componentPath": "holiday-countdown-app/src/components/holiday-countdown-widget.js",
          "baseStyle": "\n      :host { display:block; width:100%; height:100%; overflow:hidden; }\n      * { box-sizing:border-box; }\n      .wrap {\n        position: relative;\n        width:100%;\n        height:100%;\n        display:grid;\n        container-type: size;\n        color: #111111;\n        font-family: \"STKaiti\", \"KaiTi\", \"Noto Serif SC\", serif;\n        background: transparent;\n        overflow:hidden;\n        align-items: center;\n        justify-items: center;\n      }\n      /* Default layout structure (can be overridden by specific sizes) */\n      .info {\n        grid-area: info;\n        min-width: 0;\n        max-width: 100%;\n        height: 100%;\n        overflow: hidden;\n        display: flex;\n        align-items: center;\n        justify-content: flex-start;\n      }\n      .art-box {\n        grid-area: art;\n        width: 100%;\n        height: 100%;\n        min-width: 0;\n        min-height: 0;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        overflow: hidden;\n      }\n      .content {\n        width: 100%;\n        min-width: 0;\n        max-width: 100%;\n        height: 100%;\n        overflow: hidden;\n        display: flex;\n        flex-direction: column;\n        justify-content: center;\n      }\n      .sub { margin: 0 0 2%; font-size: var(--fs-sub, 3cqw); color: rgba(17,17,17,.68); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }\n      .title { margin: 0; font-size: var(--fs-title, 6cqw); line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 700; text-align: center; }\n      .num-line { margin: 0; white-space: nowrap; display:flex; align-items:baseline; justify-content: center; min-width:0; overflow:hidden; line-height: 1; }\n      .num { font-size: var(--fs-num, 14cqw); font-weight: 700; letter-spacing: -0.02em; }\n      .unit { font-size: var(--fs-unit, 4cqw); margin-left: 0.2em; }\n      .date { margin-top: 2%; font-size: var(--fs-date, 3cqw); color: rgba(17,17,17,.68); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }\n      \n      .hide-sub .sub { display:none !important; }\n      .hide-date .date { display:none !important; }\n      \n      .art { width: 100%; height: 100%; min-height: 0; opacity: 1; display:block; }\n      .art-img { width:100%; height:100%; display:block; object-fit: contain; object-position: center center; }\n      .state { width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size: 13px; color:rgba(17,17,17,.68); }\n    ",
          "sizeStyles": {
            "1x1": "\n        .wrap {\n          display: flex;\n          flex-direction: column;\n          align-items: center;\n          justify-content: center;\n          padding: 8%;\n          gap: 4%;\n        }\n        .title { font-size: 24cqmin; font-weight: 700; text-align: center; }\n        .num-line { display: flex; align-items: baseline; justify-content: center; }\n        .num { font-size: 30cqmin; font-weight: 800; }\n        .unit { font-size: 20cqmin; font-weight: 600; margin-left: 0.1em; }\n      ",
            "1x2": "\n        .wrap {\n          display: grid;\n          grid-template-columns: 30% 30% 30%;\n          column-gap: 5%;\n          padding: 0 5%;\n          height: 100%;\n          align-items: center;\n          justify-items: center;\n        }\n        .title { font-size: 20cqh; font-weight: 700; text-align: center; }\n        .num-line { display: flex; align-items: baseline; justify-content: center; }\n        .num { font-size: 26cqh; font-weight: 800; }\n        .unit { font-size: 16cqh; font-weight: 600; margin-left: 0.1em; }\n        .art-box { grid-area: auto; width: 100%; height: 80%; display: flex; align-items: center; justify-content: center; }\n        .art-img { width: 100%; height: 100%; object-fit: contain; }\n      ",
            "2x1": "\n        .wrap {\n          display: grid;\n          grid-template-rows: 30% 30% 30%;\n          row-gap: 5%;\n          padding: 5% 0;\n          width: 100%;\n          align-items: center;\n          justify-items: center;\n        }\n        .title { font-size: 20cqw; font-weight: 700; text-align: center; }\n        .num-line { display: flex; align-items: baseline; justify-content: center; }\n        .num { font-size: 26cqw; font-weight: 800; }\n        .unit { font-size: 16cqw; font-weight: 600; margin-left: 0.1em; }\n        .art-box { grid-area: auto; width: 80%; height: 100%; display: flex; align-items: center; justify-content: center; }\n        .art-img { width: 100%; height: 100%; object-fit: contain; }\n      ",
            "2x2": "\n        .wrap {\n          display: grid;\n          grid-template-areas:\n            \"sub sub\"\n            \"info art\";\n          grid-template-rows: 22% 78%;\n          grid-template-columns: 45% 55%;\n          padding: 5%;\n          gap: 2%;\n        }\n        .sub-row { grid-area: sub; display: flex; align-items: center; justify-content: center; font-size: 10cqw; font-weight: 700; }\n        .info { grid-area: info; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6%; }\n        .title { font-size: 9cqw; font-weight: 700; }\n        .num-line { display: flex; align-items: baseline; justify-content: center; }\n        .num { font-size: 16cqw; font-weight: 800; }\n        .unit { font-size: 9cqw; font-weight: 600; margin-left: 0.05em; }\n        .date { font-size: 8cqw; opacity: 0.85; }\n        .art-box { grid-area: art; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }\n        .art-img { width: 100%; height: 100%; object-fit: contain; }\n      ",
            "2x4": "\n        .wrap {\n          display: grid;\n          grid-template-areas: \"info art\";\n          grid-template-columns: 35% 65%;\n          padding: 4%;\n          gap: 2%;\n          align-items: center;\n        }\n        .info { display: flex; align-items: center; justify-content: center; height: 100%; }\n        .content { display: flex; flex-direction: column; align-items: center; gap: 4%; text-align: center; }\n        .sub { font-size: 3.5cqw; opacity: 0.85; }\n        .title { font-size: 9cqw; font-weight: 700; }\n        .num-line { display: flex; align-items: baseline; }\n        .num { font-size: 16cqw; font-weight: 800; }\n        .unit { font-size: 10cqw; font-weight: 600; margin-left: 0.05em; }\n        .date { font-size: 3.5cqw; opacity: 0.8; }\n        .art-box { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }\n        .art-img { width: 100%; height: 100%; object-fit: contain; }\n      "
          },
          "showArtSizes": [
            "1x2",
            "2x1",
            "2x2",
            "2x4"
          ],
          "hideSubSizes": [
            "1x1",
            "1x2",
            "2x1"
          ],
          "hideDateSizes": [
            "1x1",
            "1x2",
            "2x1"
          ],
          "sourcePreview": "import { html } from 'lit';\nimport { SunPanelWidgetElement } from '@sun-panel/micro-app';\nimport {\n  daysBetween,\n  formatHolidayDate,\n  normalizeHolidayName,\n  parseNextHolidayResponse,\n  resolveTrueFestivalDate\n} from '../utils/holiday-calendar.js';\nimport { getHolidayArtDataUri } from '../utils/holiday-art.js';\n\nfunction dateKeyOf(date = new Date()) {\n  const y = date.getFullYear();\n  const m = String(date.getMonth() + 1).padStart(2, '0');\n  const d = String(date.getDate()).padStart(2, '0');\n  return `${y}-${m}-${d}`;\n}\n\nfunction secondsToNextDay() {\n  const now = new Date();\n  const next = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);\n  return Math.max(60, Math.floor((next.getTime() - now.getTime()) / 1000));\n}\n\nexport class HolidayCountdownWidget extends SunPanelWidgetElement {\n  static properties = {\n    snapshot: { type: Object },\n    loading: { type: Boolean },\n    error: { type: String },\n    config: { type: Object }\n  };\n\n  static inflightMap = new Map();\n\n  constructor() {\n    super();\n    this.snapshot = null;\n    this.loading = true;\n    this.error = '';\n    this.config = {};\n    this._timer = null;\n    this._computePromise = null;\n    this._lastComputeAt = 0;\n  }\n\n  async onInitialized() {\n    this.loadConfig();\n    await this.compute({ force: true });\n    this.startTimer();\n  }\n\n  async onWidgetInfoChanged(newWidgetInfo, oldWidgetInfo) {\n    this.requestUpdate();\n    const newConfig = newWidgetInfo?.config || {};\n    const oldConfig = oldWidgetInfo?.config || {};\n    this.config = newConfig;\n    if (JSON.stringify(newConfig) !== JSON.stringify(oldConfig)) {\n      await this.compute({ force: true });\n    }\n  }\n\n  onDisconnected() {\n    if (this._timer) {\n      clearInterval(this._timer);\n      this._timer = null;\n    }\n  }\n\n  loadConfig() {\n    this.config = this.spCtx.widgetInfo?.config || {};\n  }\n\n  startTimer() {\n    if (this._timer) clearInterval(this._timer);\n    this._timer = setInterval(() => this.compute({ force: true }), 60 * 60 * 1000);\n  }\n\n  async getCache(key) {\n    try {\n      return await this.spCtx.api.localCache.app.get(key);\n    } catch (e) {\n      return null;\n    }\n  }\n\n  async setCache(key, value, ttlSec) {\n    try {\n      await this.spCtx.api.localCache.app.set(key, value, ttlSec);\n    } catch (e) {\n      // ignore\n    }\n  }\n\n  async withInflight(key, loader) {\n    const existed = HolidayCountdownWidget.inflightMap.get(key);\n    if (existed) return existed;\n    const p = (async () => {\n      try {\n        return await loader();\n      } finally {\n        HolidayCountdownWidget.inflightMap.delete(key);\n      }\n    })();\n    HolidayCountdownWidget.inflightMap.set(key, p);\n    return p;\n  }\n\n  async fetchNextHoliday(nowDateKey) {\n    return this.spCtx.api.network.request({\n      targetUrl: `https://holiday.ailcc.com/api/holiday/next/${nowDateKey}?type=Y&week=Y`,\n      method: 'GET'\n    });\n  }\n\n  async getNextWithCache(nowDateKey, now) {\n    const cacheKey = `holiday-next-${nowDateKey}`;\n    const cached = await this.getCache(cacheKey);\n    if (cached?.code === 0) {\n      return parseNextHolidayResponse(cached, now);\n    }\n\n    const res = await this.withInflight(cacheKey, async () => this.fetchNextHoliday(nowDateKey));\n    await this.setCache(cacheKey, res, secondsToNextDay());\n    return parseNextHolidayResponse(res, now);\n  }\n\n  async _computeCore() {\n    this.loading = true;\n    this.error = '';\n    try {\n      const now = new Date();\n      const nowDateKey = dateKeyOf(now);\n      const nextSnapshot = await this.getNextWithCache(nowDateKey, now);\n      const rawNext = nextSnapshot.next;\n\n      const trueDate = resolveTrueFestivalDate(rawNext?.normalizedName || rawNext?.name, now, rawNext?.dateObj || null);\n      const trueDaysLeft = trueDate ? daysBetween(now, trueDate) : rawNext?.daysLeft;\n      const next = rawNext\n        ? {\n          ...rawNext,\n          dateObj: trueDate || rawNext.dateObj,\n          date: trueDate ? formatHolidayDate(trueDate) : rawNext.date,\n          daysLeft: typeof trueDaysLeft === 'number' ? trueDaysLeft : rawNext.daysLeft,\n          isToday: trueDaysLeft === 0\n        }\n        : null;\n\n      this.snapshot = {\n        today: nextSnapshot.today,\n        next\n      };\n    } catch (e) {\n      const status = Number(e?.response?.status || 0);\n      this.error = status === 429 ? '接口限流，请稍后重试' : (e?.message || '节假日接口请求失败');\n      this.snapshot = null;\n    } finally {\n      this.loading = false;\n    }\n  }\n\n  async compute({ force = false } = {}) {\n    const now = Date.now();\n    if (!force && now - this._lastComputeAt < 10 * 1000) return;\n    if (this._computePromise) return this._computePromise;\n\n    this._lastComputeAt = now;\n    this._computePromise = this._computeCore();\n    try {\n      await this._computePromise;\n    } finally {\n      this._computePromise = null;\n    }\n  }\n\n  get nextHoliday() {\n    return this.snapshot?.next || null;\n  }\n\n  get displayHolidayName() {\n    const h = this.nextHoliday;"
        }
      ]
    },
    {
      "id": "weather-app",
      "path": "weather-app",
      "componentsConfig": "weather-app/config/components.config.js",
      "widgets": [
        {
          "id": "weather-widget",
          "sizes": [
            "1x1",
            "1x2",
            "1xfull",
            "2x1",
            "2x2",
            "2x4"
          ],
          "componentPath": "weather-app/src/components/weather-widget.js",
          "baseStyle": "\n      :host { display: block; width: 100%; height: 100%; overflow: hidden; }\n      * { box-sizing: border-box; margin: 0; padding: 0; }\n      .w {\n        width: 100%; height: 100%;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n        color: initial;\n        display: flex; flex-direction: column;\n        overflow: hidden;\n        min-height: 0;\n      }\n    ",
          "sizeStyles": {},
          "showArtSizes": null,
          "hideSubSizes": null,
          "hideDateSizes": null,
          "sourcePreview": "import { html } from 'lit';\nimport { SunPanelWidgetElement } from '@sun-panel/micro-app';\nimport { getWeatherIcon, getAqiColor, getAqiBgColor } from '../utils/weather-icons.js';\n\nexport class WeatherWidget extends SunPanelWidgetElement {\n  static properties = {\n    weather: { type: Object },\n    air: { type: Object },\n    hourly: { type: Array },\n    daily: { type: Array },\n    loading: { type: Boolean },\n    error: { type: String },\n    config: { type: Object }\n  };\n\n  constructor() {\n    super();\n    this.weather = null;\n    this.air = null;\n    this.hourly = [];\n    this.daily = [];\n    this.loading = true;\n    this.error = '';\n    this.config = {};\n    this._refreshTimer = null;\n  }\n\n  async onInitialized() {\n    await this.loadConfig();\n    await this.fetchWeather();\n    this.startAutoRefresh();\n  }\n\n  async onWidgetInfoChanged(newWidgetInfo, oldWidgetInfo) {\n    // 无论什么变化都触发重绘（包括网格尺寸变化）\n    this.requestUpdate();\n\n    // 检查配置是否变化\n    const newConfig = newWidgetInfo?.config;\n    const oldConfig = oldWidgetInfo?.config;\n\n    // 只有配置实际变化时才重新获取天气\n    if (newConfig && JSON.stringify(newConfig) !== JSON.stringify(oldConfig)) {\n      this.config = newConfig;\n      await this.fetchWeather();\n      // 刷新间隔可能变了，重新启动自动刷新\n      this.startAutoRefresh();\n    }\n  }\n\n  async loadConfig() {\n    this.config = this.spCtx.widgetInfo?.config || {};\n  }\n\n  startAutoRefresh() {\n    if (this._refreshTimer) clearInterval(this._refreshTimer);\n    const interval = (this.config?.refreshInterval || 15) * 60 * 1000;\n    this._refreshTimer = setInterval(() => this.fetchWeather(), interval);\n  }\n\n  onDisconnected() {\n    if (this._refreshTimer) {\n      clearInterval(this._refreshTimer);\n      this._refreshTimer = null;\n    }\n  }\n\n  async fetchWeather() {\n    this.loading = true;\n    this.error = '';\n\n    const createRequest = (endpoint) => ({\n      targetUrl: `https://{{host}}/v7/${endpoint}?location={{location}}&key={{apiKey}}`,\n      method: 'GET',\n      templateReplacements: [\n        { placeholder: '{{apiKey}}', fields: ['targetUrl'], dataNode: 'config.apiKey' },\n        { placeholder: '{{host}}', fields: ['targetUrl'], dataNode: 'config.apiHost' },\n        { placeholder: '{{location}}', fields: ['targetUrl'], dataNode: 'config.locationValue' }\n      ]\n    });\n\n    try {\n      // 先请求主天气，避免 templateReplacements 失败时并发放大错误日志\n      const nowRes = await this.spCtx.api.network.request(createRequest('weather/now'));\n      const [airRes, hourlyRes, dailyRes] = await Promise.all([\n        this.spCtx.api.network.request(createRequest('air/now')).catch(() => null),\n        this.spCtx.api.network.request(createRequest('weather/24h')),\n        this.spCtx.api.network.request(createRequest('weather/7d'))\n      ]);\n\n      const nowData = nowRes?.data || nowRes;\n      const airData = airRes?.data || airRes;\n      const hourlyData = hourlyRes?.data || hourlyRes;\n      const dailyData = dailyRes?.data || dailyRes;\n\n      if (nowData?.code === '200') {\n        this.weather = nowData.now;\n      } else {\n        const errorMessages = {\n          '400': '请求错误',\n          '401': 'API Key 无效',\n          '402': '超过访问次数限制',\n          '403': '无访问权限',\n          '404': '查询的数据不存在',\n          '429': '请求过于频繁',\n          '500': '服务器错误'\n        };\n        throw new Error(errorMessages[nowData?.code] || `API错误: ${nowData?.code || '未知'}`);\n      }\n\n      if (airData?.code === '200') this.air = airData.now;\n      if (hourlyData?.code === '200') this.hourly = hourlyData.hourly || [];\n      if (dailyData?.code === '200') this.daily = dailyData.daily || [];\n\n    } catch (e) {\n      const msg = String(e?.message || '');\n      if (msg.includes('data node not found') || msg.includes('failed to get data node')) {\n        this.error = '请先在配置页保存（会写入加密占位所需数据）';\n      } else {\n        this.error = e.message || '获取天气失败';\n      }\n      console.error('Weather fetch error:', e);\n    } finally {\n      this.loading = false;\n    }\n  }\n\n  onDarkModeChanged() {\n    this.requestUpdate();\n  }\n\n  get cityName() {\n    return this.config?.cityName || '未知';\n  }\n\n  get colors() {\n    const light = this.config?.textMode !== 'dark';\n    return {\n      text: light ? '#fff' : '#1a1a2e',\n      textSub: light ? 'rgba(255,255,255,0.75)' : 'rgba(0,0,0,0.6)',\n      glass: light ? 'rgba(255,255,255,0.12)' : 'rgba(0,0,0,0.06)'\n    };\n  }\n\n  // 基础样式 - 所有尺寸统一防溢出\n  get baseStyle() {\n    return `\n      :host { display: block; width: 100%; height: 100%; overflow: hidden; }\n      * { box-sizing: border-box; margin: 0; padding: 0; }\n      .w {\n        width: 100%; height: 100%;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n        color: ${this.colors.text};\n        display: flex; flex-direction: column;\n        overflow: hidden;\n        min-height: 0;\n      }\n    `;\n  }\n\n  render() {\n    const c = this.colors;\n    if (!this.config || Object.keys(this.config).length === 0) {\n      return html`<style>${this.baseStyle}.w{align-items:center;justify-content:center;font-size:11px;color:${c.textSub}}</style><div class=\"w\">请配置 API Key</div>`;\n    }\n    if (this.loading) {\n      return html`<style>${this.baseStyle}.w{align-items:center;justify-content:center;font-size:11px;color:${c.textSub}}</style><div class=\"w\">加载中...</div>`;\n    }\n    if (this.error) {\n      return html`<style>${this.baseStyle}.w{align-items:center;justify-content:center;font-size:11px;color:#f87171}</style><div class=\"w\">${this.error}</div>`;\n    }\n\n    const size = this.spCtx.widgetInfo?.gridSize;\n    switch (size) {\n      case '1x1': return this.render1x1();\n      case '1x2': return this.render1x2();\n      case '1xfull': return this.render1xfull();\n      case '2x1': return this.render2x1();\n      case '2x2': return this.render2x2();\n      case '2x4': return this.render2x4();"
        }
      ]
    }
  ]
}