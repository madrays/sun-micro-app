---
outline: [2,3]
---
# 敏感配置安全实践（可复用）

本文档总结微应用中敏感信息（如 API Key、Host、经纬度）的一套可复用方案，目标是：

- 前端默认不暴露明文
- 网络请求通过 `templateReplacements` 在运行时替换
- 配置页可“按需读取明文”（眼睛按钮）
- 支持“留空不覆盖”的安全保存策略

## 适用场景

- 三方 API 需要 `key/token` 的微应用
- `host`、`location` 等也希望隐藏
- 需要在配置页中给用户可控的“查看明文”能力

## 一、数据节点设计规范

### 1.1 节点与作用域建议

在 `app.config.js` 中定义数据节点：

```js
dataNodes: {
  config: {
    scope: 'app',
    isPublic: true
  }
}
```

说明：

- 需要跨用户共享的配置用 `scope: 'app'`
- 每用户隔离配置用 `scope: 'user'`
- 本文以 `scope: 'app'` 为例

### 1.2 关键结论：API 调用入口与 dataNode 路径是两层概念

- 读写入口决定作用域：  
  - `this.spCtx.api.dataNode.app.*`  
  - `this.spCtx.api.dataNode.user.*`
- `templateReplacements[].dataNode` 只写 `节点.键`，例如：`config.apiKey`

不要写：

- `app.config.apiKey`
- `user.config.apiKey`

正确写法：

- `config.apiKey`

## 二、敏感数据存储模型

推荐把敏感信息拆成独立 key，避免整包对象读写：

- `config.apiKey`
- `config.apiHost`
- `config.amapKey`
- `config.locationValue`

非敏感展示配置仍写入 `widget.save({ config })`，如：

- `locationMode`
- `cityName`
- `refreshInterval`
- `textMode`
- `hasSavedApiKey/hasSavedApiHost/hasSavedAmapKey`（仅状态位，不是明文）

## 三、网络请求安全模板（核心）

### 3.1 和风天气请求（隐藏 key/host/location）

```js
const request = {
  targetUrl: 'https://{{host}}/v7/weather/now?location={{location}}&key={{apiKey}}',
  method: 'GET',
  templateReplacements: [
    { placeholder: '{{apiKey}}', fields: ['targetUrl'], dataNode: 'config.apiKey' },
    { placeholder: '{{host}}', fields: ['targetUrl'], dataNode: 'config.apiHost' },
    { placeholder: '{{location}}', fields: ['targetUrl'], dataNode: 'config.locationValue' }
  ]
};
await this.spCtx.api.network.request(request);
```

### 3.2 高德逆地理（隐藏 key/经纬度）

```js
await this.spCtx.api.dataNode.app.setByKey('config', 'geoLocation', `${lng},${lat}`);

await this.spCtx.api.network.request({
  targetUrl: 'https://restapi.amap.com/v3/geocode/regeo?key={{amapKey}}&location={{geoLocation}}&extensions=base',
  method: 'GET',
  templateReplacements: [
    { placeholder: '{{amapKey}}', fields: ['targetUrl'], dataNode: 'config.amapKey' },
    { placeholder: '{{geoLocation}}', fields: ['targetUrl'], dataNode: 'config.geoLocation' }
  ]
});
```

## 四、配置页交互规范（推荐）

### 4.1 默认隐藏 + 眼睛按钮按需读取

- 输入框默认 `password` 态
- 显示“已保存/未保存/读取中”状态
- 点击眼睛时才调用 `getByKey` 读取并显示

示例逻辑：

```js
const value = await this.spCtx.api.dataNode.app.getByKey('config', 'apiKey');
```

### 4.2 保存策略：留空不覆盖

保存时建议：

- `apiKey`：输入非空才覆盖；为空且已保存则保留旧值
- `apiHost`：为空且未保存时写默认域名（如 `devapi.qweather.com`）
- `amapKey`：输入非空才覆盖

避免把空字符串写回 dataNode 覆盖掉旧密钥。

### 4.3 自动定位与高德 key 的行为

- 若当前输入了 `amapKey`：先写入 dataNode 再请求
- 若当前没输入但状态为“已保存”：直接走模板替换请求
- 若未输入且未保存：只返回经纬度，并提示“未配置高德 Key，无法自动识别城市名”

## 五、错误处理规范

常见错误：

- `data node not found`
- `no data record found`
- `Failed to apply template replacements`

建议处理：

- 配置页：提示“该字段尚未保存”
- 小部件：提示“请先在配置页保存”
- 控制台保留错误栈，UI 使用友好文案

## 六、白名单与权限清单

### 6.1 必需权限

```js
permissions: ['network', 'dataNode']
```

### 6.2 网络白名单

请求中可能出现的所有域名都要在 `networkDomains` 声明：

- 和风域名（如 `devapi.qweather.com`、`api.qweather.com`）
- 高德域名（`restapi.amap.com`）
- 若支持自定义 host，需在文档和 UI 明确提醒管理员先加白名单

## 七、复用落地清单（Checklist）

- [ ] `app.config.js` 已声明 `dataNode` 权限
- [ ] 已定义 `dataNodes.config`（scope 按需求选择 app/user）
- [ ] 敏感值未放入 `widgetInfo.config` 明文
- [ ] 所有敏感请求均通过 `templateReplacements`
- [ ] `templateReplacements.dataNode` 均为 `节点.键` 格式（如 `config.apiKey`）
- [ ] 配置页支持“默认隐藏 + 眼睛读取”
- [ ] 保存逻辑实现“留空不覆盖”
- [ ] 缺失 key 时 UI 提示清晰
- [ ] 所有目标域名已加入 `networkDomains`

## 八、推荐代码组织

- `weather-config.js`（配置页）
  - 管理输入态、隐藏态、状态标签、眼睛读取
  - 保存时写 dataNode 与 widget 公共配置
- `weather-widget.js`（卡片）
  - 仅请求数据与渲染
  - 不主动读取敏感值明文
  - 统一使用模板替换发起请求

---

如果后续要扩展到更多凭据（如 OAuth Token、Webhook Secret、私有域名），直接复用本规范：  
“明文按需读取 + 请求期模板替换 + 留空不覆盖 + 非敏感配置分离保存”。
